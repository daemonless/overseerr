# Overseerr - Media request management
# Multi-stage build: compile with npm, run with node only

ARG BASE_VERSION=15
FROM ghcr.io/daemonless/base:${BASE_VERSION} AS builder

# Build dependencies
RUN pkg update && pkg install -y \
    node20 npm-node20 yarn-node20 python311 \
    gmake pkgconf sqlite3 \
    FreeBSD-clang FreeBSD-lld FreeBSD-toolchain FreeBSD-clibs-dev FreeBSD-runtime-dev \
    ca_root_nss \
    && pkg clean -ay

# Symlink compilers
RUN ln -sf /usr/bin/clang /usr/bin/cc && \
    ln -sf /usr/bin/clang++ /usr/bin/c++

# Get latest release and download
ENV PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin
ENV NODE_OPTIONS="--max-old-space-size=2048"

RUN OVERSEERR_VERSION=$(fetch -qo - "https://api.github.com/repos/sct/overseerr/releases/latest" | jq -r '.tag_name') && \
    echo "Building Overseerr ${OVERSEERR_VERSION}" && \
    mkdir -p /app/overseerr && \
    fetch -qo - "https://github.com/sct/overseerr/archive/refs/tags/${OVERSEERR_VERSION}.tar.gz" | \
    tar xzf - -C /app/overseerr --strip-components=1 && \
    echo "${OVERSEERR_VERSION#v}" > /app/version

WORKDIR /app/overseerr

RUN CYPRESS_INSTALL_BINARY=0 yarn install --frozen-lockfile --network-timeout 1000000 && \
    yarn build && \
    yarn install --production --ignore-scripts --prefer-offline && \
    rm -rf src server .next/cache node_modules/.cache && \
    find node_modules -name "*.d.ts" -delete && \
    find node_modules -name "*.map" -delete && \
    find node_modules -name "*.md" -delete && \
    find node_modules -type d -name "test" -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true

# Production image
FROM ghcr.io/daemonless/base:${BASE_VERSION}

ARG FREEBSD_ARCH=amd64
ARG PACKAGES="node20"
ARG UPSTREAM_URL="https://api.github.com/repos/sct/overseerr/releases/latest"
ARG UPSTREAM_JQ=".tag_name"
{%- if ports %}
ARG HEALTHCHECK_ENDPOINT="http://localhost:{{ ports[0].port }}/api/v1/status"
{%- else %}
ARG HEALTHCHECK_ENDPOINT="http://localhost:5055/api/v1/status"
{%- endif %}

ENV HEALTHCHECK_URL="${HEALTHCHECK_ENDPOINT}"

# --- Metadata (Injected by Generator) ---
LABEL org.opencontainers.image.title="{{ title }}" \
      org.opencontainers.image.description="{{ description }}" \
      org.opencontainers.image.source="{{ repo_url }}" \
      org.opencontainers.image.url="{{ web_url }}" \
      org.opencontainers.image.documentation="https://docs.overseerr.dev/" \
      org.opencontainers.image.licenses="MIT" \
      org.opencontainers.image.vendor="daemonless" \
      org.opencontainers.image.authors="daemonless" \
      io.daemonless.category="{{ category }}" \
{%- if ports %}
      io.daemonless.port="{{ ports[0].port }}" \
{%- endif %}
{%- if volumes %}
      io.daemonless.volumes="{{ volumes | map(attribute='path') | join(',') }}" \
{%- endif %}
{%- if mlock %}
      org.freebsd.jail.allow.mlock="required" \
{%- endif %}
      io.daemonless.arch="${FREEBSD_ARCH}" \
      io.daemonless.upstream-url="${UPSTREAM_URL}" \
      io.daemonless.upstream-jq="${UPSTREAM_JQ}" \
      io.daemonless.healthcheck-url="${HEALTHCHECK_ENDPOINT}" \
      io.daemonless.packages="${PACKAGES}"

# Runtime dependencies only
RUN pkg update && \
    pkg install -y ${PACKAGES} && \
    pkg clean -ay && \
    rm -rf /var/cache/pkg/* /var/db/pkg/repos/*

# Copy built application from builder (with correct ownership)
COPY --from=builder --chown=bsd:bsd /app/overseerr /app/overseerr
COPY --from=builder --chown=bsd:bsd /app/version /app/version

# Create config directory
RUN mkdir -p /config && chown bsd:bsd /config

# Copy service files
COPY root/ /
RUN chmod +x /etc/services.d/*/run /etc/cont-init.d/* 2>/dev/null || true

# --- Expose (Injected by Generator) ---
{%- if ports %}
EXPOSE {{ ports | map(attribute='port') | join(' ') }}
{%- endif %}

# --- Volumes (Injected by Generator) ---
{%- if volumes %}
VOLUME {{ volumes | map(attribute='path') | join(' ') }}
{%- endif %}
